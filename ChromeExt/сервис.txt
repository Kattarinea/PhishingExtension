window.addEventListener('load', function() {
  var toggleSwitch = document.getElementById('toggleSwitch');
  var scanButton = document.getElementById('scanButton');
  scanButton.disabled = toggleSwitch.checked;

  // Загрузка сохраненного значения из хранилища
  chrome.storage.sync.get('toggleSwitchState', function(data) {
    toggleSwitch.checked = data.toggleSwitchState;
	if (toggleSwitch.checked) {
      scanButton.style.backgroundColor = "#ccc";
      scanButton.style.border = "2px solid #ccc"; 
    } else {
      scanButton.style.backgroundColor = "#ff4500";
      scanButton.style.border = "2px solid #E60000"; 
    }
    scanButton.disabled = data.toggleSwitchState;

    chrome.tabs.query({ active: true, currentWindow: true }, function(tabs) {
      var url = tabs[0].url;
      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'http://127.0.0.1:8000');
      xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
      xhr.send(JSON.stringify({ url: url }));

      xhr.onload = function() {
        if (xhr.status == 200) {
          var response = JSON.parse(xhr.responseText);
          if (response.status == 1 && toggleSwitch.checked == true) {
            chrome.action.setIcon({ path: '/icons/Phish128.png', tabId: tabs[0].id });
            scanButton.style.backgroundColor = "#ccc";
            scanButton.style.border = "2px solid #ccc"; 
          } else if (response.status == 0 && toggleSwitch.checked == true) {
            chrome.action.setIcon({ path: '/icons/Benign128.png', tabId: tabs[0].id });
            scanButton.style.backgroundColor = "#ff4500";
            scanButton.style.border = "2px solid #E60000"; 
          }
        } else {
          console.log('Request failed.  Returned status of ' + xhr.status);
        }
      };
    });
  });


  toggleSwitch.addEventListener('click', function() {
    scanButton.disabled = this.checked;
    if (this.checked) {
      scanButton.style.backgroundColor = "#ccc";
      scanButton.style.border = "2px solid #ccc"; 
    } else {
      scanButton.style.backgroundColor = "#ff4500";
      scanButton.style.border = "2px solid #E60000"; 
    }

    // Сохранение значения в хранилище
    chrome.storage.sync.set({ 'toggleSwitchState': this.checked });

    chrome.tabs.query({ active: true, currentWindow: true }, function(tabs) {
      if(toggleSwitch.checked == true){
        var url = tabs[0].url;
        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://127.0.0.1:8000');
        xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
        xhr.send(JSON.stringify({ url: url }));

        xhr.onload = function() {
          if (xhr.status == 200) {
            var response = JSON.parse(xhr.responseText);
            if (response.status == 1 && toggleSwitch.checked == true) {
              chrome.action.setIcon({ path: '/icons/Phish128.png', tabId: tabs[0].id });
            } else if (response.status == 0 && toggleSwitch.checked == true) {
              chrome.action.setIcon({ path: '/icons/Benign128.png', tabId: tabs[0].id });
            }
          } else {
            console.log('Request failed.  Returned status of ' + xhr.status);
          }
        };
      }
    });
  });
});